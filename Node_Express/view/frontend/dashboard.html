{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}


<div class="ms-3 me-3 mb-5 mt-5">
    <!-- Arena Slideshow -->
<div id="arenaCarousel" class="carousel slide mb-4 shadow-lg rounded overflow-hidden" data-bs-ride="carousel">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <img src="{{ url_for('static', filename='images/MOA_Arena.jpg') }}" class="d-block w-100 carousel-img" alt="MOA Arena">
        </div>
        <div class="carousel-item">
            <img src="{{ url_for('static', filename='images/Philippine_Arena.jpg') }}" class="d-block w-100 carousel-img" alt="Philippine Arena">
        </div>
        <div class="carousel-item">
            <img src="{{ url_for('static', filename='images/Araneta_Coliseum.jpg') }}" class="d-block w-100 carousel-img" alt="Araneta Coliseum">
        </div>
    </div>
    
    <!-- Navigation Controls -->
    <button class="carousel-control-prev" type="button" data-bs-target="#arenaCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon custom-arrow" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#arenaCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon custom-arrow" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
    </button>
</div>
<div class="container mt-5">
    <div class="ms-3 me-3 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h2>Welcome back, {{ agency_name }} ({{ username }})!</h2>
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#bookingForm">
                ➕ Add a Booking
            </button>
        </div>

        <!-- Sorting Dropdown -->
        <!-- <div class="mb-4">
            <label for="sort" class="fw-bold">Sort by:</label>
            <select id="sort" class="form-select w-auto d-inline-block" onchange="sortDashboard()">
                <option value="date" {% if not request.query.sort or request.query.sort == 'date' %}selected{% endif %}>Date</option>
                <option value="artist" {% if request.query.sort == 'artist' %}selected{% endif %}>Artist Name</option>
                <option value="venue" {% if request.query.sort == 'venue' %}selected{% endif %}>Venue</option>
            </select>
        </div> -->

        <!-- Booking and Calendar Layout -->
        <div class="row">
            <div class="col-lg-8">
                <!-- Booking History -->
                <h3 class="mb-4 fw-bold text-dark">Your Bookings</h3>
                {% if bookings %}
                    <div class="table-responsive shadow-lg rounded">
                        <table class="table align-middle text-center">
                            <thead class="bg-primary text-white">
                                <tr>
                                    <!-- <th>Receipt ID</th> -->
                                    <th>Venue</th>
                                    <th>Artist</th>
                                    <th>Date</th>
                                    <th>Time Slot</th>
                                    <th>Amount Paid</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-light">
                                {% for booking in bookings %}
                                    <tr class="border-bottom">
                                        <!-- <td class="fw-bold">{{ booking.receipt_id }}</td> -->
                                        <td>{{ booking.venue_name }}</td>
                                        <td>{{ booking.artist_name }}</td>
                                        <td>{{ booking.date }}</td>
                                        <td>{{ booking.time_slot }}</td>
                                        <td class="fw-bold text-success">₱{{ booking.amount_expected | formatNumber }}</td>
                                        <td>
                                            <span class="badge {% if booking.status == 'Paid' %}bg-success{% else %}bg-danger{% endif %} p-2">
                                                {{ booking.status }}
                                            </span>
                                        </td>
                                        <td class="d-flex gap-2">
                                            <!-- <a href="{{ url_for('view_receipt', booking_id=booking._id) }}" class="btn btn-info btn-sm">View Receipt</a> -->
                                            {% if booking.status == "Paid" %}
                                                <form method="POST" action="/cancel/{{booking._id}}">
                                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?')">Cancel</button>
                                                </form>
                                            {% else %}
                                                <!-- <span class="text-muted">Cancelled</span> -->
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-center text-muted">You have no bookings.</p>
                {% endif %}
            </div>
            
            <!-- Right Side: Calendar -->
            <div class="col-lg-4 mb-5 pt-5">
                <div class="cardd shadow p-3 mb-5">
                    <h5 class="text-center">Today's Date</h5>
                    <div id="calendar" class="text-center fs-4 text-dark"></div>
                    <div id="calendar-grid" class="mt-3"></div> <!-- Calendar Grid -->
                </div>
            </div>
        </div>

<!-- Booking Form -->
<div class="collapse mt-4 {% if request.query.error %}show{% endif %}" id="bookingForm">
    <div class="cardd shadow-lg border-0 p-4" style="background: #f8f9fa; border-radius: 12px;">
        <h4 class="mb-4 text-dark fw-bold text-center">New Booking</h4>
        <form method="POST" action="{{ url_for('book') }}">
            <div class="mb-3">
                <label class="form-label fw-semibold text-dark">Artist Name</label>
                <input type="text" name="artist_name" class="form-control border-0 shadow-sm" required 
                       value="{{ request.query.artist_name or '' }}" 
                       style="border-radius: 8px;">
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold text-dark">Concert Title</label>
                <input type="text" name="concert_title" class="form-control border-0 shadow-sm" required 
                       value="{{ request.query.concert_title or '' }}" 
                       style="border-radius: 8px;">
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold text-dark">Venue</label>
                <select name="venue" class="form-select border-0 shadow-sm" required style="border-radius: 8px;">
                    {% for venue in venues %}
                        <option value="{{ venue.name }}" {% if request.query.venue == venue.name %}selected{% endif %}>
                            {{ venue.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold text-dark">Date</label>
                <input type="date" name="date" class="form-control border-0 shadow-sm" required min="{{ today }}" 
                       style="border-radius: 8px;">
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold text-dark">Time Slot</label>
                <select name="time_slot" class="form-select border-0 shadow-sm" required style="border-radius: 8px;">
                    <option value="Morning" {% if request.query.time_slot == 'Morning' %}selected{% endif %}>
                        Morning (8:00 AM - 12:00 PM)
                    </option>
                    <option value="Afternoon" {% if request.query.time_slot == 'Afternoon' %}selected{% endif %}>
                        Afternoon (12:00 PM - 4:00 PM)
                    </option>
                    <option value="Evening" {% if request.query.time_slot == 'Evening' %}selected{% endif %}>
                        Evening (4:00 PM - 11:00 PM)
                    </option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold text-dark">Payment Method</label>
                <select name="payment_method" class="form-select border-0 shadow-sm" required style="border-radius: 8px;">
                    <option value="Credit Card">Credit Card</option>
                    <option value="GCash">GCash</option>
                    <option value="PayPal">PayPal</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success w-100 shadow-sm fw-bold" 
                    style="border-radius: 8px; font-size: 18px;">Confirm Booking</button>
        </form>
    </div>
</div>


</div>

<!-- Sorting JavaScript -->
<script>

    function sortDashboard() {

        let sortValue = document.getElementById("sort").value;

        window.location.href = "{{ url_for('dashboard') }}?sort=" + sortValue;

    }
 
    // ✅ Prevent past dates in the date picker

    document.addEventListener("DOMContentLoaded", function() {

        let today = new Date().toISOString().split('T')[0];

        document.querySelector("input[name='date']").setAttribute("min", today);

    });
</script>

<!-- FullCalendar JS -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Display current date
        let today = new Date();
        let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById("calendar").innerText = today.toLocaleDateString('en-US', options);

        // Generate a simple calendar grid
        function generateCalendar() {
            let calendarGrid = document.getElementById("calendar-grid");
            let firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
            let lastDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            let days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            
            let html = `<div class="text-center fw-bold">${today.toLocaleString('en-US', { month: 'long', year: 'numeric' })}</div>`;
            html += `<div class="d-grid grid-template-columns-7 text-center mt-2">`;
            
            // Add days of the week
            for (let day of days) {
                html += `<div class="fw-bold">${day}</div>`;
            }

            // Add blank spaces for the first week
            for (let i = 0; i < firstDay; i++) {
                html += `<div></div>`;
            }

            // Add days of the month
            for (let day = 1; day <= lastDate; day++) {
                let className = (day === today.getDate()) ? "fw-bold text-danger" : "";
                html += `<div class="${className}">${day}</div>`;
            }

            html += `</div>`;
            calendarGrid.innerHTML = html;
        }

        generateCalendar();
    });
</script>

<style>
    .grid-template-columns-7 {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
</style>
{% endblock %}
